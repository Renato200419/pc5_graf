<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometry Builder AR - Juego Educativo</title>
    <script src="https://unpkg.com/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>
    
    <script>
        // Verificar que las librer√≠as se carguen correctamente
        window.addEventListener('load', () => {
            console.log('üîç Verificando librer√≠as...');
            
            // Crear div de debug visual
            const debugDiv = document.createElement('div');
            debugDiv.id = 'debug-info';
            debugDiv.style.cssText = `
                position: fixed; top: 10px; left: 10px; 
                background: rgba(0,0,0,0.8); color: white; 
                padding: 10px; border-radius: 5px; z-index: 10000;
                font-size: 12px; max-width: 200px;
            `;
            
            const threeLoaded = !!window.THREE;
            const mindARLoaded = !!window.MindARThree;
            
            debugDiv.innerHTML = `
                <h4 style="margin: 0 0 5px 0;">üîç Debug Info</h4>
                <p style="margin: 2px 0;">THREE.js: ${threeLoaded ? '‚úÖ' : '‚ùå'}</p>
                <p style="margin: 2px 0;">MindAR: ${mindARLoaded ? '‚úÖ' : '‚ùå'}</p>
                <p style="margin: 2px 0;">HTTPS: ${location.protocol === 'https:' ? '‚úÖ' : '‚ùå'}</p>
                <button onclick="this.parentElement.remove()" style="margin-top: 5px; padding: 5px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">Cerrar</button>
            `;
            
            document.body.appendChild(debugDiv);
            
            // Auto-remove despu√©s de 15 segundos
            setTimeout(() => {
                if (debugDiv.parentElement) {
                    debugDiv.remove();
                }
            }, 15000);
            
            console.log('THREE disponible:', threeLoaded);
            console.log('MindARThree disponible:', mindARLoaded);
            
            if (!threeLoaded) {
                console.error('‚ùå THREE.js no se carg√≥ correctamente');
            }
            if (!mindARLoaded) {
                console.error('‚ùå MindAR no se carg√≥ correctamente');
            }
        });
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: #000;
            position: relative;
        }
        
        /* UI Container */
        #ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        /* Header con puntuaci√≥n */
        #header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            pointer-events: auto;
        }
        
        #score {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        
        #mission {
            font-size: 14px;
            color: #ffeb3b;
            margin: 5px 0 0 0;
        }
        
        /* Panel de herramientas */
        #toolbar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            pointer-events: auto;
        }
        
        .tool-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 24px;
        }
        
        .tool-btn:hover {
            transform: scale(1.1);
        }
        
        .tool-btn.active {
            background: #4CAF50;
            color: white;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }
        
        /* Panel lateral de informaci√≥n */
        #info-panel {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            max-width: 200px;
            pointer-events: auto;
        }
        
        /* Botones de acci√≥n */
        #action-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }
        
        .action-btn {
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Overlay de inicio */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            z-index: 2000;
            pointer-events: auto;
        }
        
        #start-overlay h1 {
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        #start-overlay p {
            font-size: 1.2em;
            text-align: center;
            margin: 10px 0;
            max-width: 400px;
        }
        
        #start-btn {
            padding: 15px 30px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s ease;
        }
        
        #start-btn:hover {
            background: #45a049;
        }
        
        /* Instrucciones */
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .instructions h3 {
            margin: 0 0 10px 0;
            color: #ffeb3b;
        }
        
        .instructions ul {
            margin: 0;
            padding-left: 20px;
        }
        
        /* Overlay de misi√≥n completada */
        #mission-complete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 1500;
            pointer-events: auto;
        }
        
        #mission-complete h2 {
            color: #4CAF50;
            margin: 0 0 15px 0;
        }
        
        #back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            background: rgba(0,0,0,0.8);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            pointer-events: auto;
            z-index: 1100;
        }
    </style>
</head>
<body>
    <!-- Overlay de inicio -->
    <div id="start-overlay">
        <h1>üéØ Geometry Builder AR</h1>
        <p>Construye estructuras geom√©tricas en realidad aumentada</p>
        
        <div class="instructions">
            <h3>üìö Objetivo Educativo (ODS 4 - Educaci√≥n)</h3>
            <ul>
                <li>Aprende geometr√≠a espacial de forma interactiva</li>
                <li>Calcula vol√∫menes y √°reas de estructuras</li>
                <li>Desarrolla pensamiento espacial y planificaci√≥n</li>
                <li>Resuelve misiones matem√°ticas divertidas</li>
            </ul>
        </div>
        
        <div class="instructions">
            <h3>üéÆ C√≥mo Jugar</h3>
            <ul>
                <li>Apunta la c√°mara a una superficie plana</li>
                <li>Selecciona una forma geom√©trica del men√∫</li>
                <li>Toca la pantalla para colocar bloques</li>
                <li>Construye estructuras y completa misiones</li>
            </ul>
        </div>
        
        <button id="start-btn">üöÄ Comenzar Juego</button>
    </div>
    
    <!-- Bot√≥n volver -->
    <button id="back-button" onclick="window.location.href='/'">‚Üê Volver</button>
    
    <!-- Contenedor de la UI del juego -->
    <div id="ui-container">
        <!-- Header con puntuaci√≥n -->
        <div id="header">
            <p id="score">Volumen Total: 0 cm¬≥</p>
            <p id="mission">Misi√≥n: Coloca tu primer bloque</p>
        </div>
        
        <!-- Toolbar de herramientas -->
        <div id="toolbar">
            <div class="tool-btn active" data-shape="cube" title="Cubo">üü¶</div>
            <div class="tool-btn" data-shape="sphere" title="Esfera">üîµ</div>
            <div class="tool-btn" data-shape="cylinder" title="Cilindro">üü´</div>
            <div class="tool-btn" data-shape="pyramid" title="Pir√°mide">üî∫</div>
            <div class="tool-btn" data-shape="eraser" title="Borrar">üóëÔ∏è</div>
        </div>
        
        <!-- Panel de informaci√≥n -->
        <div id="info-panel">
            <h4>üìê Forma Seleccionada</h4>
            <p id="shape-info">Cubo (1√ó1√ó1)</p>
            <p id="volume-info">Volumen: 1 cm¬≥</p>
            <h4>üìä Estad√≠sticas</h4>
            <p id="blocks-count">Bloques: 0</p>
            <p id="mission-progress">Progreso: 0%</p>
        </div>
        
        <!-- Botones de acci√≥n -->
        <div id="action-buttons">
            <button class="action-btn" id="clear-all">üßπ Limpiar Todo</button>
            <button class="action-btn" id="next-mission">‚û°Ô∏è Siguiente Misi√≥n</button>
            <button class="action-btn" id="help-btn">‚ùì Ayuda</button>
        </div>
    </div>
    
    <!-- Overlay de misi√≥n completada -->
    <div id="mission-complete">
        <h2>üéâ ¬°Misi√≥n Completada!</h2>
        <p id="completion-message"></p>
        <button class="action-btn" onclick="nextMission()">Continuar</button>
    </div>
    
    <script>
        console.log('üéÆ Script cargado directamente en HTML');
        
        class GeometryBuilderAR {
            constructor() {
                console.log('üéØ Inicializando GeometryBuilderAR...');
                this.setupEventListeners();
                console.log('‚úÖ Constructor completado');
            }
            
            setupEventListeners() {
                console.log('üîß Configurando event listeners...');
                
                const startBtn = document.getElementById('start-btn');
                if (startBtn) {
                    console.log('‚úÖ Bot√≥n start-btn encontrado');
                    
                    startBtn.addEventListener('click', () => {
                        console.log('üöÄ ¬°Bot√≥n presionado!');
                        this.startGame();
                    });
                } else {
                    console.error('‚ùå No se encontr√≥ el bot√≥n start-btn');
                }
            }
            
            startGame() {
                console.log('üéÆ Iniciando juego...');
                
                // Ocultar overlay de inicio
                const startOverlay = document.getElementById('start-overlay');
                if (startOverlay) {
                    startOverlay.style.display = 'none';
                    console.log('‚úÖ Overlay oculto');
                }
                
                // Crear escena b√°sica
                this.createScene();
                
                // Mostrar mensaje de √©xito
                alert('üéâ ¬°Juego iniciado exitosamente!\n\nüéØ Toca la pantalla para colocar bloques\nüîÑ Usa el men√∫ inferior para cambiar formas');
            }
            
            async createScene() {
                console.log('üåü Iniciando experiencia AR...');
                
                // Verificar si MindAR est√° disponible
                if (!window.MindARThree) {
                    console.error('‚ùå MindARThree no est√° disponible');
                    this.showMindARError('MindAR no est√° cargado. Verifica que las librer√≠as est√©n disponibles.');
                    return;
                }
                
                try {
                    console.log('üì∑ Inicializando MindAR...');
                    
                    // Verificar que el target existe
                    const targetPath = './static/assets/targets/card.mind';
                    console.log('üéØ Usando target:', targetPath);
                    
                    // Configuraci√≥n de MindAR
                    const mindConfig = {
                        container: document.body,
                        imageTargetSrc: targetPath,
                        maxTrack: 1,
                        uiLoading: 'no',
                        uiScanning: 'no',
                        uiError: 'no'
                    };
                    
                    console.log('‚öôÔ∏è Configuraci√≥n MindAR:', mindConfig);
                    
                    // Crear instancia de MindAR
                    this.mindarThree = new window.MindARThree(mindConfig);
                    
                    // Verificar que se cre√≥ correctamente
                    if (!this.mindarThree) {
                        throw new Error('No se pudo crear la instancia de MindARThree');
                    }
                    
                    console.log('‚úÖ Instancia MindAR creada');
                    
                    // Obtener renderer, scene y camera
                    const { renderer, scene, camera } = this.mindarThree;
                    
                    if (!renderer || !scene || !camera) {
                        throw new Error('Componentes de MindAR no disponibles');
                    }
                    
                    this.scene = scene;
                    this.camera = camera;
                    this.renderer = renderer;
                    
                    console.log('‚úÖ Componentes MindAR obtenidos');
                    
                    // Crear anchor para el tracking
                    this.anchor = this.mindarThree.addAnchor(0);
                    
                    if (!this.anchor) {
                        throw new Error('No se pudo crear el anchor');
                    }
                    
                    console.log('‚úÖ Anchor creado');
                    
                } catch (error) {
                    console.error('‚ùå Error detallado con MindAR:', error);
                    
                    // Mostrar debug visual en pantalla
                    const debugDiv = document.createElement('div');
                    debugDiv.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0,0,0,0.9); color: white; padding: 20px;
                        z-index: 9999; font-size: 14px; overflow-y: auto;
                    `;
                    debugDiv.innerHTML = `
                        <h2>üîç Error de AR</h2>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Target path:</strong> ${targetPath}</p>
                        <p><strong>MindAR disponible:</strong> ${!!window.MindARThree}</p>
                        <p><strong>Stack:</strong> ${error.stack}</p>
                        <p style="color: #ff6b6b; font-weight: bold; margin-top: 20px;">Esta aplicaci√≥n requiere AR para funcionar. Por favor, verifica:</p>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li>Que tengas una c√°mara disponible</li>
                            <li>Que hayas dado permisos de c√°mara</li>
                            <li>Que el archivo book.mind exista</li>
                            <li>Que est√©s usando HTTPS</li>
                        </ul>
                        <button onclick="location.reload()" style="padding: 10px; margin-top: 20px; background: #4CAF50; color: white; border: none; border-radius: 5px;">Reintentar</button>
                        <button onclick="window.location.href = '/'" style="padding: 10px; margin-top: 20px; margin-left: 10px; background: #2196F3; color: white; border: none; border-radius: 5px;">Volver al Inicio</button>
                    `;
                    document.body.appendChild(debugDiv);
                    return;
                }
                
                // Configurar luces
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.anchor.group.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                this.anchor.group.add(directionalLight);
                
                // Crear grupo de contenido que solo ser√° visible cuando se detecte el target
                this.gameContent = new THREE.Group();
                this.anchor.group.add(this.gameContent);
                
                // Crear grid en el grupo de contenido
                const gridHelper = new THREE.GridHelper(2, 4, 0x00ff00, 0x00aa00);
                this.gameContent.add(gridHelper);
                
                // Array para bloques
                this.blocks = [];
                this.currentShape = 'cube';
                
                // Inicialmente ocultar el contenido
                this.gameContent.visible = false;
                
                // Configurar eventos de tracking
                this.setupTargetTracking();
                
                // Configurar interacci√≥n
                this.setupInteraction();
                
                // Iniciar MindAR
                await this.mindarThree.start();
                console.log('‚úÖ MindAR iniciado exitosamente');
                
                // Mostrar instrucciones espec√≠ficas de AR
                setTimeout(() => {
                    this.showARInstructions();
                }, 1000);
                
                console.log('‚úÖ Escena AR creada');
            }
            
            setupTargetTracking() {
                console.log('üéØ Configurando tracking del target...');
                
                // Evento cuando se encuentra el target
                this.anchor.onTargetFound = () => {
                    console.log('üéØ ¬°Target encontrado! Mostrando contenido del juego');
                    this.gameContent.visible = true;
                    this.showTargetFoundMessage();
                };
                
                // Evento cuando se pierde el target
                this.anchor.onTargetLost = () => {
                    console.log('‚ùå Target perdido. Ocultando contenido del juego');
                    this.gameContent.visible = false;
                    this.showTargetLostMessage();
                };
            }
            
            showARInstructions() {
                const instructionDiv = document.createElement('div');
                instructionDiv.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: rgba(0,0,0,0.9); color: white; padding: 20px;
                    border-radius: 10px; text-align: center; z-index: 9999;
                    max-width: 300px; font-size: 16px;
                `;
                instructionDiv.innerHTML = `
                    <h3>üìö Geometry Builder AR</h3>
                    <p>üéØ <strong>Apunta la c√°mara a la tarjeta/carta</strong> para comenzar a jugar</p>
                    <p>üÉè Cuando detecte la tarjeta, aparecer√° el √°rea de construcci√≥n</p>
                    <p>üéÆ Toca para colocar formas geom√©tricas</p>
                    <button onclick="this.parentElement.remove()" style="padding: 10px 20px; margin-top: 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">Entendido</button>
                `;
                document.body.appendChild(instructionDiv);
                
                // Auto-remove despu√©s de 10 segundos
                setTimeout(() => {
                    if (instructionDiv.parentElement) {
                        instructionDiv.remove();
                    }
                }, 10000);
            }
            
            showTargetFoundMessage() {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                    background: rgba(76, 175, 80, 0.9); color: white; padding: 10px 20px;
                    border-radius: 20px; z-index: 9999; font-weight: bold;
                `;
                messageDiv.textContent = 'üéØ ¬°Tarjeta detectada! Ya puedes construir';
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        messageDiv.remove();
                    }
                }, 3000);
            }
            
            showTargetLostMessage() {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                    background: rgba(244, 67, 54, 0.9); color: white; padding: 10px 20px;
                    border-radius: 20px; z-index: 9999; font-weight: bold;
                `;
                messageDiv.textContent = '‚ùå Tarjeta perdida. Vuelve a apuntar la c√°mara';
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        messageDiv.remove();
                    }
                }, 3000);
            }
            
            showTargetRequiredMessage() {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                    background: rgba(255, 152, 0, 0.9); color: white; padding: 10px 20px;
                    border-radius: 20px; z-index: 9999; font-weight: bold;
                `;
                messageDiv.textContent = 'üÉè Primero apunta la c√°mara a la tarjeta para poder construir';
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        messageDiv.remove();
                    }
                }, 3000);
            }
            
            showMindARError(message) {
                console.error('‚ùå Error de MindAR:', message);
                
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: rgba(244, 67, 54, 0.95); color: white; padding: 30px;
                    border-radius: 15px; text-align: center; z-index: 9999;
                    max-width: 400px; font-size: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                `;
                errorDiv.innerHTML = `
                    <h2 style="margin: 0 0 20px 0; color: #ffcdd2;">üö´ Error de AR</h2>
                    <p style="margin: 10px 0;"><strong>Problema:</strong> ${message}</p>
                    <p style="margin: 20px 0; color: #ffcdd2; font-weight: bold;">Esta aplicaci√≥n requiere realidad aumentada para funcionar correctamente.</p>
                    <div style="text-align: left; margin: 15px 0; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                        <strong>Verifica que:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>Tu dispositivo tenga c√°mara</li>
                            <li>Hayas dado permisos de c√°mara</li>
                            <li>Est√©s usando HTTPS</li>
                            <li>El archivo card.mind est√© disponible</li>
                        </ul>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                        <button onclick="location.reload()" style="padding: 12px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">üîÑ Reintentar</button>
                        <button onclick="window.location.href = '/'" style="padding: 12px 20px; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">üè† Volver al Inicio</button>
                    </div>
                `;
                document.body.appendChild(errorDiv);
            }
            
            setupInteraction() {
                // Configurar interacci√≥n del canvas
                if (this.renderer && this.renderer.domElement) {
                    const canvas = this.renderer.domElement;
                    
                    canvas.addEventListener('click', (event) => {
                        // Solo permitir colocaci√≥n si el target est√° visible (en modo AR) o estamos en modo b√°sico
                        if (!this.gameContent || this.gameContent.visible || !this.mindarThree) {
                            this.placeBlock(event);
                        } else {
                            this.showTargetRequiredMessage();
                        }
                    });
                    
                    canvas.addEventListener('touchstart', (event) => {
                        event.preventDefault();
                        // Solo permitir colocaci√≥n si el target est√° visible (en modo AR) o estamos en modo b√°sico
                        if (!this.gameContent || this.gameContent.visible || !this.mindarThree) {
                            this.placeBlock(event);
                        } else {
                            this.showTargetRequiredMessage();
                        }
                    });
                }
                
                // Configurar toolbar
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentShape = btn.dataset.shape;
                        this.updateShapeInfo();
                    });
                });
            }
            
            placeBlock(event) {
                console.log('üéØ Colocando bloque:', this.currentShape);
                
                if (this.currentShape === 'eraser') {
                    this.removeLastBlock();
                    return;
                }
                
                // Posici√≥n aleatoria para demo
                const x = (Math.random() - 0.5) * 3;
                const z = (Math.random() - 0.5) * 3;
                const y = 0.25;
                
                let geometry, material;
                
                switch(this.currentShape) {
                    case 'cube':
                        geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                        material = new THREE.MeshLambertMaterial({ color: 0x4CAF50 });
                        break;
                    case 'sphere':
                        geometry = new THREE.SphereGeometry(0.25, 16, 16);
                        material = new THREE.MeshLambertMaterial({ color: 0x2196F3 });
                        break;
                    case 'cylinder':
                        geometry = new THREE.CylinderGeometry(0.25, 0.25, 0.5, 16);
                        material = new THREE.MeshLambertMaterial({ color: 0xFF9800 });
                        break;
                    case 'pyramid':
                        geometry = new THREE.ConeGeometry(0.25, 0.5, 8);
                        material = new THREE.MeshLambertMaterial({ color: 0xE91E63 });
                        break;
                }
                
                const block = new THREE.Mesh(geometry, material);
                block.position.set(x, y, z);
                block.userData = { shape: this.currentShape };
                
                // Si estamos en modo AR, agregar al gameContent; si no, a la escena directamente
                if (this.gameContent && this.gameContent.visible) {
                    this.gameContent.add(block);
                } else if (this.scene) {
                    this.scene.add(block);
                }
                
                this.blocks.push(block);
                
                this.updateStats();
            }
            
            removeLastBlock() {
                if (this.blocks.length > 0) {
                    const lastBlock = this.blocks.pop();
                    
                    // Remover del contenedor correcto
                    if (this.gameContent && lastBlock.parent === this.gameContent) {
                        this.gameContent.remove(lastBlock);
                    } else if (this.scene && lastBlock.parent === this.scene) {
                        this.scene.remove(lastBlock);
                    }
                    
                    this.updateStats();
                }
            }
            
            updateStats() {
                const totalBlocks = this.blocks.length;
                const volume = totalBlocks * 0.125; // Volumen aproximado
                
                document.getElementById('score').textContent = `Volumen Total: ${volume.toFixed(2)} cm¬≥`;
                document.getElementById('blocks-count').textContent = `Bloques: ${totalBlocks}`;
                
                if (totalBlocks === 0) {
                    document.getElementById('mission').textContent = 'Misi√≥n: Coloca tu primer bloque';
                } else if (totalBlocks < 5) {
                    document.getElementById('mission').textContent = `Misi√≥n: Coloca ${5 - totalBlocks} bloques m√°s`;
                } else {
                    document.getElementById('mission').textContent = '¬°Misi√≥n completada! Sigue construyendo';
                }
            }
            
            updateShapeInfo() {
                const shapeNames = {
                    cube: 'Cubo (0.5√ó0.5√ó0.5)',
                    sphere: 'Esfera (r=0.25)',
                    cylinder: 'Cilindro (r=0.25, h=0.5)',
                    pyramid: 'Pir√°mide (base=0.5)',
                    eraser: 'Borrador'
                };
                
                const volumes = {
                    cube: '0.125',
                    sphere: '0.065',
                    cylinder: '0.098',
                    pyramid: '0.042',
                    eraser: '0'
                };
                
                document.getElementById('shape-info').textContent = shapeNames[this.currentShape] || 'Desconocido';
                document.getElementById('volume-info').textContent = `Volumen: ${volumes[this.currentShape] || '0'} cm¬≥`;
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                
                // Rotaci√≥n suave
                if (this.scene) {
                    this.scene.rotation.y += 0.005;
                }
                
                this.renderer.render(this.scene, this.camera);
            }
        }
        
        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM cargado, inicializando juego...');
            window.gameInstance = new GeometryBuilderAR();
        });
        
        // Funciones globales
        window.nextMission = function() {
            alert('üéâ ¬°Misi√≥n completada! Contin√∫a construyendo.');
        };
    </script>
</body>
</html>
